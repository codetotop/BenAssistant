default_platform(:android)

platform :android do
  # Notification functions
  desc "Send Telegram notification"
  private_lane :send_telegram_notification do |options|
    sh("curl -X POST 'https://api.telegram.org/bot#{ENV['TELEGRAM_BOT_TOKEN']}/sendMessage' \
       -H 'Content-Type: application/json' \
       -d '{
         \"chat_id\": \"#{options[:chat_id]}\",
         \"text\": \"#{options[:message]}\",
         \"parse_mode\": \"Markdown\",
         \"disable_web_page_preview\": false
       }'")
  end

  # Update link helper to accept app_id
  desc "Get Firebase download link with release ID"
  private_lane :get_firebase_link do |firebase_result, app_id|
    # Extract release ID from Firebase response
    release_id = firebase_result.is_a?(Hash) ?
      (firebase_result[:name]&.split('/')&.last ||
       Actions.lane_context[SharedValues::FIREBASE_APP_DISTRO_RELEASE]) : nil

    if release_id && !release_id.empty?
      link = "https://appdistribution.firebase.google.com/testerapps/#{app_id}/releases/#{release_id}"
      UI.message("âœ… Direct testerapps link: #{link}")
      link
    else
      link = "https://appdistribution.firebase.google.com/pub/i/#{app_id}"
      UI.message("âš ï¸ Using fallback public link: #{link}")
      link
    end
  end

  private_lane :resolve_app_id do |options|
    flavor = options[:flavor]
    case flavor
    when 'dev'
      ENV['FIREBASE_APP_ID_DEV'] || ENV['FIREBASE_APP_ID']
    when 'staging'
      ENV['FIREBASE_APP_ID_STAGING'] || ENV['FIREBASE_APP_ID']
    else # 'prod'
      ENV['FIREBASE_APP_ID_PROD'] || ENV['FIREBASE_APP_ID']
    end
  end

  desc "Upload to Firebase and get download link"
  private_lane :upload_to_firebase do |options|
    notes = sh("git log -1 --pretty=%B").strip
    notes = "No release notes provided." if notes.empty?

    version_code = android_get_version_code(gradle_file: "app/build.gradle.kts") ||
                  sh("git rev-list --count HEAD").strip
    version_name = android_get_version_name(gradle_file: "app/build.gradle.kts") ||
                  (sh("git describe --tags --abbrev=0").strip rescue "0.1.0-dev")

    app_id = resolve_app_id(flavor: options[:flavor] || 'dev')
    UI.user_error!("Missing FIREBASE_APP_ID for flavor #{options[:flavor] || 'prod'}") unless app_id && !app_id.empty?

    result = firebase_app_distribution(
      app: app_id,
      service_credentials_file: File.expand_path("service_account.json", __dir__),
      testers: "dungnb@nal.vn, dungletk2109@gmail.com",
      release_notes: "[#{options[:build_type]} BUILD] Version: #{version_name} (#{version_code})\n#{notes}"
    )

    {
      download_url: get_firebase_link(result, app_id),
      version_info: "#{version_name} (#{version_code})"
    }
  end

  desc "Send build notifications"
  private_lane :notify_build_result do |options|
    if options[:success]
      build_type = options[:build_type]
      info = options[:info]

      dev_msg = "#{build_type == 'DEBUG' ? 'âœ…' : 'ğŸ‰'} *#{build_type} Build Success!*\\n\\n" \
                "ğŸ“± Version: #{info[:version_info]}\\n" \
                "ğŸ”— Download: #{info[:download_url]}"

      tester_msg = "#{build_type == 'DEBUG' ? 'âœ… *Debug Build Ready!*' : 'ğŸ‰ *Release Build Ready!*'}\\n\\n" \
                   "ğŸ“± Version: #{info[:version_info]}\\n" \
                   "ğŸ”— Download: #{info[:download_url]}\\n\\n" \
                   "ğŸ“‹ #{build_type == 'DEBUG' ? 'Test all features and report issues' : 'Final QA before production'}"

      send_telegram_notification(chat_id: ENV['TELEGRAM_DEV_CHAT_ID'], message: dev_msg)
      send_telegram_notification(chat_id: ENV['TELEGRAM_TESTER_CHAT_ID'], message: tester_msg)
    else
      # Failure notification
      build_type = options[:build_type]
      error_msg = options[:error].to_s.gsub(/[_*\[\]()~`>#+=|{}.!-]/) { |match| "\\#{match}" }
      error_msg = error_msg[0..300] + "..." if error_msg.length > 300

      failure_msg = "âŒ *#{build_type} Build Failed!*\\n\\n" \
                    "âš ï¸ Error: #{error_msg}\\n\\n" \
                    "ğŸ” Check the CI logs for details"

      send_telegram_notification(chat_id: ENV['TELEGRAM_DEV_CHAT_ID'], message: failure_msg)
    end
  end

  # Main build lanes
  desc "Build dev debug APK and upload to Firebase"
  lane :debug do
    UI.message("ğŸ”§ Starting dev debug build...")
    gradle(task: "test")
    gradle(task: "assembleDevDebug")

    info = upload_to_firebase(build_type: "DEBUG", flavor: "dev")
    notify_build_result(success: true, build_type: "DEBUG", info: info)
  end

  desc "Build prod release APK and upload to Firebase"
  lane :release do
    UI.message("ğŸš€ Starting prod release build...")
    gradle(task: "assembleStagingDebug")

    info = upload_to_firebase(build_type: "RELEASE", flavor: "staging")
    notify_build_result(success: true, build_type: "RELEASE", info: info)
  end

  # Legacy lanes for compatibility
  lane :build_test do
    gradle(task: "test")
  end

  lane :build_debug do
    gradle(task: "assembleDevDebug")
  end

  lane :build_release do
    gradle(task: "assembleStagingDebug")
  end

  desc "Deploy to Google Play"
  lane :deploy do
    build_release
    upload_to_play_store
  end
end
