default_platform(:android)

platform :android do
  # Notification functions
  desc "Send Telegram notification"
  private_lane :send_telegram_notification do |options|
    chat_id = options[:chat_id]
    message = options[:message]

    sh("curl -X POST 'https://api.telegram.org/bot#{ENV['TELEGRAM_BOT_TOKEN']}/sendMessage' \
       -H 'Content-Type: application/json' \
       -d '{
         \"chat_id\": \"#{chat_id}\",
         \"text\": \"#{message}\",
         \"parse_mode\": \"Markdown\",
         \"disable_web_page_preview\": false
       }'")
  end

  desc "Get Firebase App Distribution link and version info"
  private_lane :get_app_info do
    # Use the actual download URL from Firebase, fallback to general app link
    firebase_link = ENV['FIREBASE_DOWNLOAD_URL'] || "https://appdistribution.firebase.dev/i/#{ENV['FIREBASE_APP_ID']}"

    # Get version from gradle file
    version_name = android_get_version_name(gradle_file: "app/build.gradle.kts") || git_version_name
    version_code = android_get_version_code(gradle_file: "app/build.gradle.kts") || git_version_code

    {
      download_url: firebase_link,
      version_info: "#{version_name} (#{version_code})"
    }
  end

  desc "Notify success for debug build"
  lane :notify_debug_success do
    app_info = get_app_info

    # Notify developers
    dev_message = "âœ… *Build Debug Success!*\\n\\nðŸ“± *Version:* #{app_info[:version_info]}\\nðŸŒ¿ *Branch:* #{ENV['GITHUB_REF_NAME']}\\nðŸ‘¨â€ðŸ’» *Author:* #{ENV['GITHUB_ACTOR']}\\n\\nðŸ”— [Download APK](#{app_info[:download_url]})"

    send_telegram_notification(
      chat_id: ENV['TELEGRAM_DEV_CHAT_ID'],
      message: dev_message
    )

    # Notify testers
    tester_message = "âœ… *Debug Build Ready for Testing!*\\n\\nðŸ“± *Version:* #{app_info[:version_info]}\\nðŸŒ¿ *Branch:* #{ENV['GITHUB_REF_NAME']}\\n\\nðŸš€ *Ready to test!*\\nðŸ”— [Download APK](#{app_info[:download_url]})\\n\\n_Please test all features and report any issues._"

    send_telegram_notification(
      chat_id: ENV['TELEGRAM_TESTER_CHAT_ID'],
      message: tester_message
    )
  end

  desc "Notify success for release build"
  lane :notify_release_success do
    app_info = get_app_info

    # Notify developers
    dev_message = "ðŸŽ‰ *Release Build Success!*\\n\\nðŸ“± *Version:* #{app_info[:version_info]}\\nðŸŒ¿ *Branch:* #{ENV['GITHUB_REF_NAME']}\\nðŸ“ *Commit:* #{ENV['GITHUB_SHA']}\\n\\nðŸ”— [Download APK](#{app_info[:download_url]})"

    send_telegram_notification(
      chat_id: ENV['TELEGRAM_DEV_CHAT_ID'],
      message: dev_message
    )

    # Notify testers
    tester_message = "ðŸŽ‰ *Release Build Ready for Production!*\\n\\nðŸ“± *Version:* #{app_info[:version_info]}\\nðŸŒ¿ *Branch:* #{ENV['GITHUB_REF_NAME']}\\n\\nâœ… *Ready for final testing before production!*\\nðŸ”— [Download APK](#{app_info[:download_url]})\\n\\n_Please perform final QA testing._"

    send_telegram_notification(
      chat_id: ENV['TELEGRAM_TESTER_CHAT_ID'],
      message: tester_message
    )
  end

  desc "Notify build failure"
  lane :notify_build_failure do |options|
    build_type = options[:build_type] || "Build"
    error_msg = options[:error] || "Check logs for details"

    failure_message = "ðŸ”´ *#{build_type} Failed!*\\n\\nðŸŒ¿ *Branch:* #{ENV['GITHUB_REF'] || 'local'}\\nðŸ“ *Commit:* #{ENV['GITHUB_SHA'] || 'local'}\\nðŸ‘¨â€ðŸ’» *Author:* #{ENV['GITHUB_ACTOR'] || 'local'}\\n\\nâŒ *Error:* #{error_msg}\\n\\nðŸ” Check workflow logs for more details"

    send_telegram_notification(
      chat_id: ENV['TELEGRAM_DEV_CHAT_ID'],
      message: failure_message
    )
  end

  # Test lane
  desc "Runs all the tests"
  lane :build_test do
    gradle(task: "test")
  end

  # Build debug APK
  desc "Builds the debug APK"
  lane :build_debug do
    gradle(task: "assembleDebug")
  end

  # Build release APK
  desc "Builds the release APK"
  lane :build_release do
    gradle(task: "assembleRelease")
  end

  # set_version
  lane :git_version_code do
    sh("git rev-list --count HEAD").strip
  end

  lane :git_version_name do
    tag = sh("git describe --tags --abbrev=0", log: false).strip rescue nil
    tag || "0.1.0-dev"
  end

  lane :set_version do
    vc = android_get_version_code(gradle_file: "app/build.gradle.kts") || git_version_code
    vn = android_get_version_name(gradle_file: "app/build.gradle.kts") || git_version_name

    UI.message("Version set: #{vn} (#{vc})")
  end

  lane :release_notes_from_git do
    notes = sh("git log -1 --pretty=%B").strip
    notes.empty? ? "No release notes provided." : notes
  end

  # Upload Debug APK to Firebase App Distribution
  desc "Upload Debug APK to Firebase App Distribution"
  lane :upload_debug_firebase do
    notes = release_notes_from_git
    version_code = android_get_version_code(gradle_file: "app/build.gradle.kts") || git_version_code
    version_name = android_get_version_name(gradle_file: "app/build.gradle.kts") || git_version_name

    result = firebase_app_distribution(
      app: ENV['FIREBASE_APP_ID'],
      service_credentials_file: File.expand_path("service_account.json", __dir__),
      testers: "dungnb@nal.vn, dungletk2109@gmail.com",
      release_notes: "[DEBUG BUILD] Version: #{version_name} (#{version_code})\n#{notes}"
    )

    # Store the download URL for notifications
    ENV['FIREBASE_DOWNLOAD_URL'] = result[:downloadUrl] || result['downloadUrl'] || "https://appdistribution.firebase.dev/i/#{ENV['FIREBASE_APP_ID']}"
  end

  # Upload Release APK to Firebase App Distribution
  desc "Upload Release APK to Firebase App Distribution"
  lane :upload_release_firebase do
    notes = release_notes_from_git
    version_code = android_get_version_code(gradle_file: "app/build.gradle.kts") || git_version_code
    version_name = android_get_version_name(gradle_file: "app/build.gradle.kts") || git_version_name

    result = firebase_app_distribution(
      app: ENV['FIREBASE_APP_ID'],
      service_credentials_file: File.expand_path("service_account.json", __dir__),
      testers: "dungnb@nal.vn, dungletk2109@gmail.com",
      release_notes: "[RELEASE BUILD] Version: #{version_name} (#{version_code})\n#{notes}"
    )

    # Store the download URL for notifications
    ENV['FIREBASE_DOWNLOAD_URL'] = result[:downloadUrl] || result['downloadUrl'] || "https://appdistribution.firebase.dev/i/#{ENV['FIREBASE_APP_ID']}"
  end

  desc "Build debug APK and upload to Firebase App Distribution"
  lane :debug do
    begin
      set_version
      build_test
      build_debug
      upload_debug_firebase
      notify_debug_success  # Call notification after upload to get download URL
    rescue => exception
      notify_build_failure(build_type: "Debug Build", error: exception.message)
      raise exception
    end
  end

  desc "Build release APK and upload to Firebase App Distribution"
  lane :release do
    begin
      set_version
      build_release
      upload_release_firebase
      notify_release_success  # Call notification after upload to get download URL
    rescue => exception
      notify_build_failure(build_type: "Release Build", error: exception.message)
      raise exception
    end
  end

  desc "Deploy a new version to the Google Play"
  lane :deploy do
    build_release
    upload_to_play_store
  end
end
